# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

import("../ios/fastlane/Fastfile")
import("lib/properties.rb")
import("lib/git.rb")

### All the configs are in this file, eventually all project specific parts will move there
import("lib/config.rb")

# Common checks before running a lane
before_all do |lane, options|
  options[:platform] = options[:platform] || Config::PLATFORM
  options[:android_output] = options[:android_output] || Config::ANDROID_OUTPUT
  options[:flavor] = options[:flavor] || Config::FLAVOR
  options[:build] = options[:build] || Config::BUILD
  options[:coverage] = options[:coverage] || false
  ## downloading the iOS adhoc profile
  options[:downloadProfile] = options[:downloadProfile] || false

  version_name = gitVersionName()
  build_number = gitVersionNumber()
  options[:build_number] = options[:build_number] || build_number
  options[:version_name] = options[:version_name] || version_name
  puts options
end

# Private lanes, that we only call internally, they are nice because they have an own description
desc "Flutter build"
private_lane :flutter_build do |options|
  clean(options)
  pub_get(options)
  build_runner(options)

  platform = options[:platform]
  target = platform == "android" ? options[:android_output] : platform
  type = options[:build] == "release" ? "--release" : "--debug"
  codesign = platform == "ios" ? "--no-codesign" : ""
  flavor = options[:flavor]
  appName = Config::FLAVOR_MATRIX[flavor][platform]["name"]
  appId = Config::FLAVOR_MATRIX[flavor][platform]["id"]

  defines = {
    "GIT_TAG" => options[:version_name],
    "USER_APP_ID" => appId,
    "USER_APP_NAME" => appName,
  }

  if platform == "ios"
    defines["USER_PROVISIONING_PROFILE"] = Config::IOS_BUILD_CONFIG[flavor]["provisioning_profile_name"]
  end
  dartDefines = defines.map { |k, v| " --dart-define=#{k}=\"#{v}\"" }.reduce("", :+)

  flutter("build #{target} #{type} #{codesign} --build-number=#{options[:build_number]} --build-name=#{options[:version_name]} --dart-define=GIT_TAG=#{options[:version_name]} --dart-define=USER_APP_ID=#{appId} --dart-define=USER_APP_NAME=\"#{appName}\" #{dartDefines}")
end

desc "Build internal apk"
private_lane :android_prepare_internal do |options|
  UI.user_error!("No PROVISIONING_PASSWORD provided!") unless ENV.key?("PROVISIONING_PASSWORD")
  provisionigPassword = ENV["PROVISIONING_PASSWORD"]
  setProperties("../android/key.properties", {
    :storePassword => provisionigPassword,
    :keyPassword => provisionigPassword,
    :keyAlias => "release",
    :storeFile => "internal_release.jks",
  })
end

####
#### Public lanes, can also be used via tab completion: `fastlane enable_auto_complete`
####

desc "Update strings"
lane :update_strings do |options|
  download_translations(
    api_token: "2f6281279c106f795f0c0c099eb38d8f",
    project_id: "502883",
    languages: "de,en",
    output_dir: "lib/presentation/constants/translations/",
  )
  # Need to move default language file to translations.i18n.yaml for the i18n build generator
  shell("mv lib/presentation/constants/translations/translations_en.i18n.yaml lib/presentation/constants/translations/translations.i18n.yaml")
  build_runner(options)
end

desc "Flutter build runner"
lane :build_runner do |options|
  check_config_files(options)
  command = "pub  run build_runner build --delete-conflicting-outputs"
  begin
    flutter(command)
  rescue => ex
    pub_get(options)
    flutter(command)
  end
end

desc "Checks alle the config (env, properties, etc) if they are correctly set"
lane :check_config_files do |options|
  askAndSetProperties("../.env.dev",
                      {
    "SEARCH_API_URL_DEBUG" => "SEARCH_API_BASE_URL",
    "SEARCH_API_SECRET_DEBUG" => "SEARCH_API_SECRET_KEY",
    "IMAGE_FETCHER_URL_DEBUG" => "IMAGE_FETCHER_URL",
    "INSTABUG_TOKEN_DEBUG" => "INSTABUG_TOKEN",
    "AMPLITUDE_API_KEY_DEBUG" => "AMPLITUDE_API_KEY",
  })

  askAndSetProperties("../.env.prod",
                      {
    "SEARCH_API_URL_PRODUCTION" => "SEARCH_API_BASE_URL",
    "SEARCH_API_SECRET_PRODUCTION" => "SEARCH_API_SECRET_KEY",
    "IMAGE_FETCHER_URL_PRODUCTION" => "IMAGE_FETCHER_URL",
    "INSTABUG_TOKEN_PRODUCTION" => "INSTABUG_TOKEN",
    "AMPLITUDE_API_KEY_PRODUCTION" => "AMPLITUDE_API_KEY",
  })

  if options[:flavor] != "internal" && options[:release] != "debug"
    askAndSetProperties("../android/custom.properties", { "INSTABUG_TOKEN_PRODUCTION" => "INSTABUG_TOKEN" })
  else
    askAndSetProperties("../android/custom.properties", { "INSTABUG_TOKEN_DEBUG" => "INSTABUG_TOKEN" })
  end
end

desc "Flutter pub get"
lane :pub_get do |options|
  flutter("pub get")
end

desc "Watch changes for rerunning the build_runner"
lane :watch do |options|
  flutter("packages pub run build_runner watch --delete-conflicting-outputs")
end

desc "Flutter clean"
lane :clean do |options|
  flutter("clean")
end

desc "Sanity checks (options: coverage:[true/FALSE])"
lane :check do |options|
  pub_get(options)
  if Dir.glob("../**/env.g.dart").empty?
    build_runner(options)
  end
  flutter("analyze lib test")
  if is_ci
    flutter("format ./ --set-exit-if-changed")
  else
    flutter("format ./")
  end
  if options[:coverage]
    # Creates a fake test that imports all files so that lcov calculates the correct coverage
    shell('find lib ! -name "*.freezed.dart" ! -name "*.config.dart" ! -name "*.g.dart" ! -name "generated_plugin_registrant.dart"  -name *.dart  | sed \'s/lib\///\' | sed  \'s/.*/import "package:xayn_discovery_app\/&";/\' > test/all_imports_test.dart')
    shell("cat test/test_stub.dart >> test/all_imports_test.dart")
    flutter("test --coverage")
    lcov_ignore_rules = shell("cat lcov_ignore | grep -v \\# | tr '\n' ' '")
    shell("mv coverage/lcov.info coverage/original_lcov.info")
    shell("lcov --remove coverage/original_lcov.info #{lcov_ignore_rules} -o coverage/lcov.info")
    shell("genhtml coverage/lcov.info -o coverage/html")
  else
    flutter("test")
  end
end

desc "Build and publish (i.e fastlane publish platform:ios build:release flavor:beta)"
lane :publish do |options|
  platform = options[:platform]
  flavor = options[:flavor]
  config = Config::FLAVOR_MATRIX[flavor][platform]
  appcenter_target = config["appcenter_target"]
  appcenter_token = config["appcenter_token"]
  appcenter_buildfile = config["appcenter_buildfile"]

  if platform == "android"
    android_prepare_internal
  end
  flutter_build(options)
  if platform == "ios"
    Dir.chdir("../ios/fastlane") do
      ios_create_ipa(options)
    end
  end
  UI.user_error!("No $#{appcenter_token} provided!") unless ENV.key?(appcenter_token)
  uploadToAppCenter(
    ENV[appcenter_token],
    appcenter_target,
    appcenter_buildfile,
    options[:version_name]
  )
end

# Private helper methods
def flutter(args)
  Dir.chdir("..") do
    sh "flutter #{args}"
  end
end

def shell(args)
  Dir.chdir("..") do
    sh(args)
  end
end

def uploadToAppCenter(token, appName, path, version)
  changelog = gitChangeLog(version)
  appcenter_upload(
    api_token: token,
    owner_name: Config::APPCENTER_OWNER_NAME,
    owner_type: Config::APPCENTER_OWNER_TYPE,
    app_name: appName,
    file: path,
    release_notes: changelog,
    destinations: Config::APPCENTER_DEFAULT_TARGET,
    notify_testers: true,
  )
end
